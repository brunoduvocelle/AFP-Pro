<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>AFP PRO - Scan Haute Disponibilité</title>
    <style>
        :root {
            --bg: #050505; --card: #111; --border: #222;
            --accent: #0070f3; --text: #eee; --scan: #00ff41; --err: #ff4444;
        }
        body { 
            font-family: system-ui, sans-serif; background: var(--bg); color: var(--text);
            display: grid; grid-template-columns: 1fr 380px; height: 100vh; margin: 0;
        }
        #feed { padding: 30px; overflow-y: auto; border-right: 1px solid var(--border); }
        aside { background: #000; display: flex; flex-direction: column; padding: 20px; }
        .monitor { background: #0a0a0a; border: 1px solid var(--border); padding: 15px; border-radius: 10px; margin-bottom: 15px; }
        .log-area { flex: 1; overflow-y: auto; font-family: monospace; font-size: 11px; color: #555; border-top: 1px solid var(--border); padding-top: 10px; }
        .log-entry.fail { color: var(--err); }
        .log-entry.ok { color: var(--scan); }
        .news-card { background: var(--card); border: 1px solid var(--border); padding: 15px; margin-bottom: 10px; border-radius: 8px; animation: slide 0.3s ease; }
        @keyframes slide { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; } }
        button { width: 100%; padding: 12px; background: var(--accent); color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; margin-bottom: 10px; }
        .source-tag { font-size: 10px; color: var(--accent); font-weight: bold; text-transform: uppercase; }
    </style>
</head>
<body>

    <main id="feed">
        <div style="text-align:center; padding-top:100px; color:#444;">
            <h2>Système de Veille Multilflux</h2>
            <p>Cliquez sur "Lancer" pour contourner les blocages CORS.</p>
        </div>
    </main>

    <aside>
        <div class="monitor">
            <div style="font-size:10px; color:#666; margin-bottom:5px;">MÉMOIRE ACTIVE</div>
            <div id="count" style="font-size:32px; font-weight:bold; color:var(--scan);">0</div>
            <button onclick="App.run()">Lancer le Monitoring</button>
            <button style="background:#333;" onclick="App.copyAll()">Concatenation Totale</button>
        </div>
        <div class="log-area" id="logs"></div>
    </aside>

    <script>
        const App = {
            data: [],
            seen: new Set(),
            sources: [
                { n: "Le Monde", u: "https://www.lemonde.fr/rss/une.xml" },
                { n: "Le Figaro", u: "https://www.lefigaro.fr/rss/figaro_actualites.xml" },
                { n: "Les Echos", u: "https://services.lesechos.fr/rss/les-echos-economie.xml" },
                { n: "BFMTV", u: "https://www.bfmtv.com/rss/info/flux-rss/flux-toutes-les-infos/" },
                { n: "France 24", u: "https://www.france24.com/fr/actualites/rss" }
            ],

            log(m, cl = '') {
                const e = document.getElementById('logs');
                const d = document.createElement('div');
                d.className = `log-entry ${cl}`;
                d.textContent = `[${new Date().toLocaleTimeString()}] ${m}`;
                e.prepend(d);
            },

            async fetchWithFallback(url) {
                // Tentative 1: rss2json
                try {
                    const r = await fetch(`https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}&api_key=00000000000000000000000000000000`);
                    const j = await r.json();
                    if (j.status === 'ok') return j.items;
                } catch(e) {}

                // Tentative 2: Proxy AllOrigins (Contournement CORS)
                try {
                    const r = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
                    const j = await r.json();
                    const parser = new DOMParser();
                    const xml = parser.parseFromString(j.contents, "text/xml");
                    const items = Array.from(xml.querySelectorAll("item")).map(i => ({
                        title: i.querySelector("title")?.textContent,
                        description: i.querySelector("description")?.textContent,
                        pubDate: i.querySelector("pubDate")?.textContent,
                        link: i.querySelector("link")?.textContent
                    }));
                    return items;
                } catch(e) { return null; }
            },

            async run() {
                document.getElementById('feed').innerHTML = '';
                this.log("Initialisation du scan résilient...");
                
                for (const src of this.sources) {
                    const items = await this.fetchWithFallback(src.u);
                    if (items) {
                        this.log(`Succès : ${src.n}`, 'ok');
                        items.forEach(item => {
                            const id = btoa(unescape(encodeURIComponent(item.title))).substring(0, 20);
                            if (!this.seen.has(id)) {
                                this.seen.add(id);
                                item.source = src.n;
                                this.data.push(item);
                                this.render(item);
                            }
                        });
                    } else {
                        this.log(`Échec Critique : ${src.n}`, 'fail');
                    }
                }
                document.getElementById('count').textContent = this.seen.size;
            },

            render(i) {
                const c = document.createElement('div');
                c.className = 'news-card';
                c.innerHTML = `<div class="source-tag">${i.source}</div><div style="font-weight:bold;margin:5px 0;">${i.title}</div><div style="font-size:12px;color:#888;">${(i.description||"").replace(/<[^>]*>?/gm, '').substring(0,120)}...</div>`;
                document.getElementById('feed').prepend(c);
            },

            copyAll() {
                const txt = this.data.map(i => `[${i.source}] ${i.title}\n${i.link}`).join('\n\n');
                navigator.clipboard.writeText(txt);
                alert("Tout est copié (" + this.data.length + " dépêches)");
            }
        };
    </script>
</body>
</html>
